<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<record id="view_hr_payslip_tree" model="ir.ui.view">
		<field name="name">hr.payslip.tree</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<tree decoration-info="state=='verify'"
				decoration-muted="state == 'cancel'" string="Payslips">
				<field name="number" />
				<field name="employee_id" />
				<field name="name" />
				<field name="date_from" />
				<field name="date_to" />
				<field name="basic_wage" sum="Total" />
				<field name="gross_salary" sum="Total" />
				<field name="net_salary" sum="Total" />
				<field name="company_cost" sum="Total" />
				<field name="currency_id" invisible="1" />
				<field name="thirteen_month_pay" />
				<field name="state" />
				<field name="company_id" groups="base.group_multi_company" />
				<field name="payslip_run_id" invisible="1" />
			</tree>
		</field>
	</record>

	<record id="hr_payslip_view_kanban" model="ir.ui.view">
		<field name="name">hr.payslip.kanban</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<kanban class="o_kanban_mobile">
				<templates>
					<t t-name="kanban-box">
						<div t-attf-class="oe_kanban_content oe_kanban_global_click">
							<div class="row">
								<div class="col-6">
									<strong>
										<field name="employee_id" />
									</strong>
								</div>
								<div class="col-6">
									<span class="float-right badge badge-secondary">
										<field name="state" />
									</span>
								</div>
								<div class="col-12">
									<span>
										<field name="date_from" />
										-
										<field name="date_to" />
									</span>
								</div>
								<div class="col-12">
									<span>
										<field name="name" />
									</span>
								</div>
							</div>
						</div>
					</t>
				</templates>
			</kanban>
		</field>
	</record>

	<record id="act_payslip_lines" model="ir.actions.act_window">
			<field name="name">Payslip Computation Details</field>
			<field name="res_model">hr.payslip.line</field>
			<field name="binding_model_id" ref="to_hr_payroll.model_hr_payslip"/>
			<field name="context">{'default_slip_id': active_id,'search_default_slip_id': active_id}</field>
	</record>

	<record id="view_hr_payslip_form" model="ir.ui.view">
		<field name="name">hr.payslip.form</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<form string="Payslip">
				<header>
					<button string="Confirm" name="action_payslip_verify"
						groups="to_hr_payroll.group_hr_payroll_user" type="object"
						states="draft" class="oe_highlight" />
					<button string="Send Email" name="action_payslip_send_wizard"
						groups="to_hr_payroll.group_hr_payroll_user"
						type="object" class="oe_highlight" />
					<button string="Mark as Done" name="action_payslip_done"
						groups="to_hr_payroll.group_hr_payroll_user" type="object"
						states="verify" class="oe_highlight" />
					<button string="Refund" name="refund_sheet"
						groups="to_hr_payroll.group_hr_payroll_user" states="verify,done"
						type='object' />
					<button string="Set to Draft" name="action_payslip_draft"
						groups="to_hr_payroll.group_hr_payroll_user" type="object"
						states="cancel" />
					<button string="Compute Sheet" name="compute_sheet"
						groups="to_hr_payroll.group_hr_payroll_user" type="object"
						states="draft" class="oe_highlight" />
					<button string="Cancel Payslip" name="action_payslip_cancel"
						groups="to_hr_payroll.group_hr_payroll_user" type="object"
						states="verify,done" />
					<field name="state" widget="statusbar"
						statusbar_visible="draft,verify,done,cancel" />
				</header>
				<sheet>
					<div class="oe_button_box" name="button_box">
						<button name="%(act_payslip_lines)d" class="oe_stat_button"
							icon="fa-money" type="action">
							<field name="payslip_lines_count" widget="statinfo"
								string="Payslip Lines" help="Payslip Computation Details" />
						</button>
						<button name="action_view_hr_working_month_calendar_lines"
							class="oe_stat_button" icon="fa-clipboard" type="object"
							groups="base.group_no_one">
							<field name="working_month_calendar_lines_count"
								widget="statinfo" string="Work Entries"
								help="Show all the related working history records" />
						</button>
						<button name="action_view_refunds" class="oe_stat_button"
							icon="fa-money" type="object"
							attrs="{'invisible': [('refunds_count','=',0)]}">
							<field name="refunds_count" widget="statinfo"
								string="Refunds"
								help="Payslips that are the refunds for this payslip" />
						</button>
					</div>
					<div class="oe_title">
						<label for="employee_id" class="oe_edit_only" />
						<h1>
							<field name="employee_id" placeholder="Employee" />
						</h1>
					</div>
					<group col="4">
						<field name="salary_cycle_id" groups="base.group_no_one" />
						<field name="thirteen_month_pay" />
						<field name="thirteen_month_pay_year"
							attrs="{'invisible': [('thirteen_month_pay','=',False)], 'required':[('thirteen_month_pay','=',True)]}" />
						<field name="thirteen_month_pay_include_trial"
							attrs="{'invisible': [('thirteen_month_pay','=',False)]}" />
						<label for="date_from" string="Period" />
						<div>
							<field name="date_from" class="oe_inline" />
							-
							<field name="date_to" class="oe_inline" />
						</div>
						<field name="contract_id"
							domain="[('employee_id','=',employee_id),('date_start','&lt;=',date_to),'|',('date_end','&gt;=',date_from),('date_end','=',False)]"
							context="{'default_employee_id': employee_id}" />
						<!-- This caused access right error for normal users who don't have access rights reading contracts
						<field name="contract_ids" widget="many2many_tags"
							attrs="{'invisible': [('contracts_count','&lt;=',1)]}"
							groups="base.group_no_one" />
						-->
						<field name="contracts_count" invisible="1" />
						<field name="number" />
						<field name="struct_id"
							attrs="{'required':[('contract_id','!=',False)]}" />
						<field name="name" />
						<field name="credit_note" />
						<field name="company_id" groups="base.group_multi_company" />
						<field name="currency_id" invisible="1" />
						<field name="salary_computation_mode" invisible="1" />
					</group>
					<notebook>
						<page string="Worked Days &amp; Contributions &amp; Inputs">
							<group string="Working Calendar Info">
								<group>
									<label for="calendar_working_hours" />
									<div class="o_row">
										<field name="calendar_working_hours" />
										<span>hours</span>
									</div>
									<label for="calendar_working_days" />
									<div class="o_row">
										<field name="calendar_working_days" />
										<span>days</span>
									</div>
								</group>
								<group>
									<label for="duty_working_hours" />
									<div class="o_row">
										<field name="duty_working_hours" />
										<span>hours</span>
									</div>
									<label for="duty_working_days" />
									<div class="o_row">
										<field name="duty_working_days" />
										<span>days</span>
									</div>
								</group>
								<group>
									<label for="worked_hours" />
									<div class="o_row">
										<field name="worked_hours" />
										<span>hours</span>
									</div>
									<label for="worked_days" />
									<div class="o_row">
										<field name="worked_days" />
										<span>days</span>
									</div>
								</group>
							</group>
							<group string="Leave Summary">
								<group>
									<label for="leave_hours" />
									<div class="o_row">
										<field name="leave_hours" />
										<span>hours</span>
									</div>
									<label for="leave_days" />
									<div class="o_row">
										<field name="leave_days" />
										<span>days</span>
									</div>
								</group>
								<group>
									<label for="unpaid_leave_hours" />
									<div class="o_row">
										<field name="unpaid_leave_hours" />
										<span>hours</span>
									</div>
									<label for="unpaid_leave_days" />
									<div class="o_row">
										<field name="unpaid_leave_days" />
										<span>days</span>
									</div>
								</group>
							</group>
							<separator string="Working Calendar Details" />
							<field name="working_month_calendar_ids" nolabel="1">
								<tree>
									<field name="month" />
									<field name="month_int" invisible="1" force_save="1" />
									<field name="year_int" invisible="1" force_save="1" />
									<field name="duty_working_hours"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','hour_basis')]}" />
									<field name="duty_working_days"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','day_basis')]}" />
									<field name="month_working_hours"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','hour_basis')]}" />
									<field name="month_working_days"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','day_basis')]}" />
									<field name="leave_hours"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','hour_basis')]}" />
									<field name="leave_days"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','day_basis')]}" />
									<field name="unpaid_leave_hours"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','hour_basis')]}" />
									<field name="unpaid_leave_days"
										attrs="{'column_invisible': [('parent.salary_computation_mode','!=','day_basis')]}" />
									<field name="paid_rate" />
									<!-- This caused access right error for normal users who don't have access rights reading contracts
									<field name="contract_ids" widget="many2many_tags"
										groups="base.group_no_one" />
									 -->
									<field name="resource_calendar_ids"
										widget="many2many_tags" groups="base.group_no_one" />
								</tree>
							</field>
							<div name="working_month_calendar_ids_help" class="alert alert-info border-0 rounded-0" role="alert"
								groups="base.group_no_one">
								You can access these values of the Working Calendar Details in
								salary rule's
								Python code as:
								<ul>
									<li>
										either
										<code>payslip.working_month_calendar_ids</code>
									</li>
									<li>
										or (in multi-contract mode, in which there could be more than
										one
										contract in a single month of a payslip)
										<code>working_month_calendar_lines</code>
									</li>
								</ul>
								Below are examples for multi-contract mode, which should also
								work fine for single contract mode,
								<ol>
									<li>
										For basic wage calculation:
										<br />
										<code>
											result=sum(line.contract_id.wage * line.paid_rate for
											line in working_month_calendar_lines.filtered(lambda l:
											l.contract_id))
										</code>
									</li>
									<li>
										For travel allowance calculation:
										<br />
										<code>
											result = 0.0
											<br />
											# Loop over the payslip's working calendar lines that link to
											contract for allowance
											<br />
											for line in
											working_month_calendar_lines.filtered(lambda
											l:
											l.contract_id):
											<br />
											&#160;&#160;&#160;&#160;advantages =
											line.contract_id.get_advatages_obj()
											<br />
											&#160;&#160;&#160;&#160;result += advantages.TRAVEL.amount *
											line.paid_rate
										</code>
									</li>
								</ol>
							</div>
							<separator string="Worked Days"
								groups="base.group_no_one" />
							<field name="worked_days_line_ids"
								groups="base.group_no_one">
								<tree string="Worked Days" editable="bottom">
									<field name="name" />
									<field name="code" />
									<field name="number_of_days" sum="Total Working Days" />
									<field name="number_of_hours" />
									<field name="contract_id" />
									<field name="sequence" invisible="True" />
								</tree>
								<form string="Worked Day">
									<group col="4">
										<field name="name" />
										<field name="code" />
										<field name="sequence" />
										<field name="number_of_days" />
										<field name="number_of_hours" />
										<field name="contract_id" />
									</group>
								</form>
							</field>
							<div class="alert alert-info border-0 rounded-0" role="alert"
								groups="base.group_no_one">
								You can access these values of the Worked Days in salary rule's
								Python code as:
								<code>result = worked_days.CODE.field_name</code>
								<br />
								Where,
								<br />
								<ul>
									<li>CODE: is the code of a worked days line specified above.
									</li>
									<li>
										field_name: the name of a field of the model
										<code>hr.payslip.worked_days</code>
										.
									</li>
								</ul>
								Examples,
								<ol>
									<li>
										<code>result=worked_days.WORK100.number_of_days</code>
										for number of days
									</li>
									<li>
										<code>result=worked_days.WORK100.number_of_hours</code>
										for number of hours
									</li>
								</ol>
							</div>
							<separator string="Payslip Contribution Lines" />
							<field name="hr_payslip_contribution_line_ids" readonly="1"
								force_save="1" widget="one2many_list" nolabel="1">
								<tree string="Payroll Contribution Registers">
									<field name="payroll_contrib_history_id"
										groups="base.group_no_one" force_save="1" />
									<field name="code" />
									<field name="date_from" force_save="1" />
									<field name="date_to" force_save="1" />
									<field name="contribution_base" string="Base" />
									<field name="employee_contrib_rate"
										string="Employee Rate" />
									<field name="company_contrib_rate" string="Company Rate" />
									<field name="currency_id" invisible="1" />
									<field name="state" />
								</tree>
								<form string="Payslip Contribution Line">
									<group>
										<group>
											<field name="payroll_contrib_history_id" />
											<field name="code" />
											<field name="date_from" />
											<field name="date_to" />
											<field name="contribution_base" />
										</group>
										<group>
											<field name="employee_contrib_rate" />
											<field name="employee_contribution" />
											<field name="company_contrib_rate" />
											<field name="company_contribution" />
											<field name="currency_id" invisible="1" />
										</group>
									</group>
								</form>
							</field>
							<div class="alert alert-info" role="alert"
								groups="base.group_no_one">
								You can access these values of the Payslip Contribution Lines
								in
								salary rule's Python code as:
								<code>result = contributions.CODE.field_name</code>
								<br />
								Where,
								<br />
								<ul>
									<li>CODE: is the code of a contribution line specified above.
									</li>
									<li>
										field_name: the name of a field of the model
										<code>hr.payslip.contribution.line</code>
										.
									</li>
								</ul>
								Examples,
								<ol>
									<li>
										<code>result=contributions.SOCIAL_INSURANCE.employee_contribution
										</code>
										for the amount of contribution to social insurance by the
										employee.
									</li>
									<li>
										<code>result=contributions.SOCIAL_INSURANCE.company_contribution
										</code>
										for the amount of contribution to social insurance by the
										company.
									</li>
								</ol>
							</div>
							<separator string="Other Inputs" />
							<field name="input_line_ids" colspan="4" nolabel="1">
								<tree string="Input Data" editable="bottom">
									<field name="name" />
									<field name="code" />
									<field name="amount" />
									<field name="contract_id" />
									<field name="sequence" invisible="True" />
									<field name="salary_rule_id" invisible="1" />
								</tree>
								<form string="Payslip Line">
									<group col="4">
										<field name="name" />
										<field name="code" />
										<field name="sequence" />
										<field name="amount" />
										<field name="contract_id" />
										<field name="salary_rule_id" />
									</group>
								</form>
							</field>
						</page>
						<page string="Salary Computation">
							<field name="line_ids" colspan="4" nolabel="1">
								<tree string="Salary Structure" editable="bottom"
									decoration-info="total == 0">
									<field name="name" />
									<field name="code" />
									<field name="category_id" />
									<field name="sequence" invisible="1" />
									<field name="quantity" />
									<field name="rate" />
									<field name="salary_rule_id" />
									<field name="amount" />
									<field name="total" />
									<field name="currency_id" invisible="1" />
									<field name="company_id" invisible="1" />
								</tree>
								<form string="Payslip Line">
									<group col="4">
										<field name="name" />
										<field name="code" />
										<field name="category_id" />
										<field name="sequence" />
										<field name="quantity" />
										<field name="rate" />
										<field name="amount" />
										<field name="total" />
										<field name="salary_rule_id" />
										<field name="currency_id" invisible="1" />
										<field name="company_id" invisible="1" />
									</group>
								</form>
							</field>
						</page>
						<page string="Details By Salary Rule Category">
							<field name="details_by_salary_rule_category"
								context="{'group_by':'category_id'}"
								domain="[('appears_on_payslip', '=', True)]">
								<tree string="Payslip Lines" decoration-info="total == 0">
									<field name="category_id" />
									<field name="name" />
									<field name="code" />
									<field name="total" />
									<field name="currency_id" invisible="1" />
									<field name="company_id" invisible="1" />
								</tree>
							</field>
						</page>
						<page name="personal_tax"
							string="Personal Income Tax Details">
							<group>
								<group>
									<field name="personal_tax_policy" />
									<field name="personal_tax_rule_id" />
								</group>
								<group>
									<field name="gross_salary" />
									<field name="personal_tax_base_deduction" />
									<field name="dependent_deduction" />
									<field name="personal_tax_base" />
								</group>
							</group>
							<separator string="Tax computation breaks" />
							<field name="payslip_personal_income_tax_ids" nolabel="1"
								readonly="1">
								<tree>
									<field name="personal_tax_policy" />
									<field name="upper_base" />
									<field name="personal_tax_rule_escalation_id"
										attrs="{'invisible':[('parent.personal_tax_policy','!=','escalation')]}" />
									<field name="currency_id" invisible="1" />
									<field name="rate" string="Rate (%)" />
									<field name="base" sum="Taxed Amount" />
									<field name="tax_amount" sum="Total Personal Tax Value" />
								</tree>
							</field>
						</page>
						<page id="page_account" string="Accounting Information"
							groups="to_hr_payroll.group_hr_payroll_user">
							<group>
								<group string="Miscellaneous">
									<field name="company_id"
										groups="base.group_multi_company"
										options="{'no_create': True}" />
									<field name="payslip_run_id"
										domain="[('state','=','draft')]" />
									<field name="company_cost" />
								</group>
								<group name="accounting" string="Accounting">
									<field name="paid" readonly="1" />
								</group>
							</group>
							<div colspan="4">
								<field name="note" placeholder="Add an internal note..." />
							</div>
						</page>
					</notebook>
				</sheet>
				<div class="oe_chatter">
					<field name="message_follower_ids" groups="base.group_user" />
					<field name="activity_ids"/>
					<field name="message_ids"/>
				</div>
			</form>
		</field>
	</record>

	<record model="ir.ui.view" id="hr_payslip_pivot_view">
		<field name="name">HR Payslip Pivot</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<pivot string="Payslip Analysis">
				<field name="date_to" type="col" />
				<field name="department_id" type="row" />
				<field name="gross_salary" type="measure" />
				<field name="company_cost" type="measure" />
			</pivot>
		</field>
	</record>

	<record model="ir.ui.view" id="hr_payslip_graph_view">
		<field name="name">HR Payslip Graph</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<graph string="Payslip Analysis" type="bar" stacked="1">
				<field name="department_id" />
				<field name="employee_id" />
				<field name="gross_salary" type="measure" />
			</graph>
		</field>
	</record>

	<record id="view_hr_payslip_filter" model="ir.ui.view">
		<field name="name">hr.payslip.select</field>
		<field name="model">hr.payslip</field>
		<field name="arch" type="xml">
			<search string="Search Payslips">
				<field name="name" string="Payslips"
					filter_domain="['|',('name','ilike',self),('number','ilike',self)]" />
				<separator />
				<field name="employee_id" />
				<field name="department_id" />
				<field name="job_id" />
				<separator />
				<field name="payslip_run_id" />
				<separator />
				<field name="basic_wage" />
				<field name="gross_salary" />
				<field name="net_salary" />
				<separator />
				<field name="company_cost" />
				<separator />
				<field name="date_from" />
				<field name="date_to" />
				<separator />
				<filter string="Draft" name="draft"
					domain="[('state','=','draft')]" help="Draft" />
				<filter string="Waiting" name="ftr_waiting"
					domain="[('state','=','verify')]" help="Waiting" />
				<filter string="Done" name="done"
					domain="[('state','=','done')]" help="Done" />
				<filter string="Cancelled" name="ftr_cancel"
					domain="[('state','=','cancel')]" help="Cancelled" />
				<separator />
				<filter name="ftr_13month" string="13rd-Month Pay Only"
					domain="[('thirteen_month_pay', '=', True)]" />
				<filter name="ftr_no_13month" string="Without 13rd-Month Pay"
					domain="[('thirteen_month_pay', '=', False)]" />
				<separator />
				<filter string="This Year" name="ftr_this_year"
					domain="[('date_from','&gt;=',time.strftime('%%Y-01-01'))]" />
				<filter string="Last Year" name="ftr_last_year"
					domain="[
						('date_from','&gt;=',(context_today()-relativedelta(years=1)).strftime('%Y-01-01')),
						('date_to','&lt;=',(context_today()-relativedelta(years=1)).strftime('%Y-12-31'))
						]" />
				<filter string="This Month" name="ftr_this_month"
						domain="[('date_from','&gt;=',time.strftime('%Y-%m-01'))]" />
					<filter string="Last Month" name="ftr_last_month"
						domain="[
							('date_from','&gt;=',(context_today()-relativedelta(months=1)).strftime('%Y-%m-01')),
							('date_to','&lt;=',(context_today().replace(day=1)-relativedelta(days=1)).strftime('%Y-%m-%d'))
							]" />
				<separator />
				<group expand="0" string="Group By">
					<filter string="Employees" name="employee_id"
						context="{'group_by':'employee_id'}" />
					<filter string="Department" name="grp_department"
						context="{'group_by':'department_id'}" />
					<filter string="Job Position" name="grp_job"
						context="{'group_by':'job_id'}" />
					<filter string="PaySlip Batch" name="payslip_run_id"
						context="{'group_by':'payslip_run_id'}" />
					<filter string="Companies" name="company_id"
						groups="base.group_multi_company"
						context="{'group_by':'company_id'}" />
					<filter string="States" name="state"
						context="{'group_by':'state'}" />
				</group>
			</search>
		</field>
	</record>

	<record id="action_view_hr_payslip_form"
		model="ir.actions.act_window">
		<field name="name">Payslips</field>
		<field name="res_model">hr.payslip</field>
		<field name="view_mode">tree,pivot,graph,kanban,form</field>
		<field name="search_view_id" ref="view_hr_payslip_filter" />
	</record>

	<menuitem id="menu_payslips_root" name="Payslips" sequence="0"
		groups="base.group_user" parent="menu_hr_payroll_root" />

	<menuitem action="action_view_hr_payslip_form" sequence="5"
		id="menu_payslips" parent="menu_payslips_root"
		groups="base.group_user" />

	<record id="act_hr_employee_payslip_list"
		model="ir.actions.act_window">
		<field name="res_model">hr.payslip</field>
		<field name="name">Payslips</field>
		<field name="view_mode">tree,pivot,form</field>
		<field name="context">{'search_default_employee_id':[active_id],'default_employee_id':active_id}</field>
	</record>

	<record id="action_server_payslip_send_mail"
		model="ir.actions.server">
		<field name="name">Send Mail</field>
		<field name="type">ir.actions.server</field>
		<field name="model_id" ref="model_hr_payslip" />
		<field name="binding_model_id" ref="model_hr_payslip" />
		<field name="state">code</field>
		<field name="code">records.action_payslip_send()</field>
	</record>

</odoo>
