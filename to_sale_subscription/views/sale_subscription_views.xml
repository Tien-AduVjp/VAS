<?xml version="1.0" encoding="utf-8"?>
<odoo>
	<record id="sale_subscription_view_list" model="ir.ui.view">
		<field name="name">sale.subscription.list</field>
		<field name="model">sale.subscription</field>
		<field name="groups_id" eval="[(4, ref('account.group_account_invoice'))]" />
		<field name="arch" type="xml">
			<tree string="Sale Subscriptions" decoration-warning="to_renew"
				decoration-muted="not in_progress">
				<field name="code" />
				<field name="partner_id" />
				<field name="date_start" optional="hide" />
				<field name="date_end" optional="hide" />
				<field name="recurring_next_date" />
				<field name="pricelist_id" invisible="1" />
				<field name="user_id" />
				<field name="recurring_total" />
				<field name="company_id" groups="base.group_multi_company" />
				<field name="stage_id" />
				<field name="in_progress" optional="hide" />
				<field name="to_renew" optional="hide" />
				<field name="company_currency" invisible="1"/>
			</tree>
		</field>
	</record>

	<record id="sale_subscription_view_form" model="ir.ui.view">
		<field name="name">sale.subscription.form</field>
		<field name="model">sale.subscription</field>
		<field name="arch" type="xml">
			<form string="Subscription" class="o_viin_subscription_form">
				<header>
					<button string="Create Invoice"
						name="action_recurring_create_invoice" type="object"
						attrs="{'invisible': [('in_progress', '=', False)]}"
						class="btn-primary oe_stat_button" />
					<button string="Create A Renewal Quotation"
						help="Create a sale order that will overwrite this subscription when confirmed (renewal quotation)"
						name="action_prepare_renewal_order" type="object"
						attrs="{'invisible': [('to_renew', '=', False)]}" />
					<button string="Upsell"
						help="Add options to the subscription directly or through a quotation"
						name="%(to_sale_subscription.wizard_action)d" type="action"
						attrs="{'invisible': [('in_progress', '=', False)]}" />
					<button string="Close" help="Close the subscription"
						name="%(to_sale_subscription.sale_subscription_close_reason_wizard_action)d"
						type="action" attrs="{'invisible': [('in_progress', '=', False)]}" />
					<field name="stage_id" widget="statusbar"
						options="{'clickable': '1'}" />
				</header>
				<sheet string="Subscription">
					<div class="oe_button_box" name="button_box">
						<button class="oe_stat_button" icon="fa-globe"
							name="open_website_url" type="object" string="Online Preview">
						</button>
						<button class="oe_stat_button" icon="fa-book"
							name="action_view_invoices" type="object"
							groups="account.group_account_invoice"
							attrs="{'invisible': [('invoice_count','=',0)]}">
							<field name="invoice_count" widget="statinfo"
								string="Invoices" />
						</button>
						<button class="oe_stat_button" icon="fa-credit-card"
							name="action_view_sales_orders" type="object"
							groups="sales_team.group_sale_salesman">
							<field name="sale_order_count" widget="statinfo" string="Sales" />
						</button>
						<button name="action_view_all_rating" type="object"
								attrs="{'invisible': ['|', '|', ('rating_status', '=', 'no'), ('rating_percentage_satisfaction', '=', -1)]}"
								class="oe_stat_button oe_percent" icon="fa-smile-o"
								groups="to_sale_subscription.group_subscription_rating">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_value">
                                    <field name="rating_percentage_satisfaction" nolabel="1"/>
                                </span>
                                <span class="o_stat_text">
                                    % On Subscriptions />
                                </span>
                            </div>
                        </button>
					</div>
					<div class="oe_title">
						<h1 class="flex-fill d-flex flex-row" attrs="{'invisible': [('id', '=', False)]}">
							<field name="is_favorite" widget="boolean_favorite" class="mr-3" nolabel="1" />
							<field name="display_name" class="text-truncate" />
						</h1>
						<h1 attrs="{'invisible': [('id', '!=', False)]}">
							<field name="name" readonly="1" />
						</h1>
					</div>
					<div class="badge-pill badge-warning float-left" attrs="{'invisible': [('to_renew', '=', False)]}">To Renew</div>
					<group name="main">
						<group name='customer'>
							<field name="currency_id" invisible="1" />
							<field name="company_currency" invisible="1"/>
							<field name="template_id" />
							<field name="partner_id" required="1" />
							<field name="pricelist_id" groups="product.group_sale_pricelist" />
							<field name="code" />
							<field name="close_reason_id" attrs="{'invisible': [('in_progress', '=', True)]}" />
							<field name="company_id" groups="base.group_multi_company" />
							<field name="in_progress" invisible="1" />
						</group>
						<group name="other">
							<field name="date_start" />
							<field name="date_end" />
							<label for="recurring_next_date"
								string="Date of Next Invoice"
								attrs="{'invisible': [('in_progress', '=', False)]}" />
							<div attrs="{'invisible': [('in_progress', '=', False)]}">
								<field name="recurring_next_date" />
								<button string="&#8658; Generate Invoice" class="oe_link"
									name="action_recurring_create_invoice" type="object"
									attrs="{'invisible': [('payment_mode', '=', 'manual')]}"
									groups="base.group_no_one" />
							</div>
							<field name="to_renew" />
						</group>
					</group>
					<notebook>
						<page string="Subscription Lines" id="lines">
							<field name="line_ids">
								<tree editable="bottom">
									<field name="product_id"
										domain="[('recurring_invoice', '=', True)]"
										context="{'default_recurring_invoice': True}" />
									<field name="name" />
									<field name="quantity" />
									<field name="uom_id" groups="uom.group_uom" />
									<field name="price_unit" />
									<field name="discount"
										groups="product.group_discount_per_so_line" />
									<field name="price_subtotal" />
								</tree>
							</field>
							<group class="oe_subtotal_footer oe_right">
								<field name="recurring_total"
									class="oe_subtotal_footer_separator" widget="monetary"
									options="{'currency_field': 'currency_id'}"
									modifiers="{'readonly': true}" />
							</group>
						</page>
						<page name="sale" string="Sales Information">
							<group>
								<group>
									<field name="user_id" />
								</group>
								<group>
									<field name="team_id" />
								</group>
							</group>
						</page>
						<page name="description" string="Terms and Conditions">
							<field name="description" />
						</page>
						<page string="Settings" id="settings">
							<group>
								<group name="analytic" groups="analytic.group_analytic_accounting,analytic.group_analytic_tags">
									<field name="analytic_account_id" groups="analytic.group_analytic_accounting" />
									<field name="analytic_tag_ids" widget="many2many_tags" options="{'color_field': 'color'}"
									   groups="analytic.group_analytic_tags"/>
								</group>
								<group name="payment">
									<field name="payment_mode" invisible="1" />
									<field name="payment_token_id"
										attrs="{'invisible': [('payment_mode', 'in', ['manual', 'draft_invoice'])]}" />
								</group>
							</group>
                            <group id="rating_settings" class="col-lg-6 o_setting_box" name="customer_rating" groups="to_sale_subscription.group_subscription_rating">
                                <div class="o_setting_right_pane">
                                    <b>Customer(s) Ratings</b>
                                    <div class="text-muted">
                                        Get customer feedback
                                    </div>
                                    <div>
                                        <field name="rating_status" widget="radio"/>
                                        <p attrs="{'invisible': [('rating_status','not in',('periodic','stage'))]}" class="text-muted oe_edit_only">
                                            Edit subscription's stages and set an email template on the stages on which you want to activate the rating.
                                        </p>
                                        <div  attrs="{'required': [('rating_status','=','periodic')], 'invisible': [('rating_status','!=','periodic')]}">
                                            <label for="rating_status_period"/>
                                            <field name="rating_status_period"  class="oe_inline"/>
                                        </div>
                                        <div attrs="{'invisible': [('rating_status','==','no')]}">
                                            <label for="portal_show_rating"/>
                                            <field name="portal_show_rating"/>
                                        </div>
                                    </div>
                                </div>
                            </group>
						</page>
					</notebook>
				</sheet>
				<div class="oe_chatter">
					<field name="message_follower_ids"/>
					<field name="activity_ids"/>
					<field name="message_ids"/>
				</div>
			</form>
		</field>
	</record>

	<record id="sale_subscription_view_kanban" model="ir.ui.view">
		<field name="name">sale.subscription.kanban</field>
		<field name="model">sale.subscription</field>
		<field name="arch" type="xml">
			<kanban default_group_by="stage_id" class="o_kanban_mobile">
				<field name="user_id" />
				<field name="partner_id" />
				<field name="stage_id" />
				<field name="is_favorite" />
				<field name="color" />
				<field name="recurring_total" />
				<field name="template_id" />
				<field name="currency_id" />
				<field name="activity_ids" />
				<field name="to_renew" />
				<field name="in_progress" />
				<field name="rating_ids" />
				<field name="rating_last_value" />
				<field name="rating_percentage_satisfaction"/>
                <field name="rating_status"/>
				<field name="activity_state" />
				<field name="company_currency" invisible="1"/>
				<progressbar field="activity_state"
					colors='{"planned": "success", "today": "warning", "overdue": "danger"}'
					sum_field="recurring_total"
					help="This bar allows to filter the subscriptions based on scheduled activities." />
				<templates>
					<t t-name="kanban-box">
						<div t-attf-class="#{kanban_color(record.color.raw_value)} oe_kanban_card oe_kanban_global_click">
							<div class="o_dropdown_kanban dropdown">
								<a class="dropdown-toggle o-no-caret btn" role="button" data-toggle="dropdown" data-display="static" href="#" aria-label="Dropdown menu" title="Dropdown menu">
								    <span class="fa fa-ellipsis-v"/>
								</a>
								<div class="dropdown-menu" role="menu">
									<t t-if="widget.editable"><a role="menuitem" type="edit" class="dropdown-item">Edit</a></t>
									<t t-if="widget.deletable"><a role="menuitem" type="delete" class="dropdown-item">Delete</a></t>
									<ul class="oe_kanban_colorpicker" data-field="color"/>
								</div>
							</div>
							<div class="oe_kanban_content">
								<div>
									<span class="o_right"><field name="is_favorite" widget="boolean_favorite" nolabel="1" force_save="1"/></span>
									<strong class="o_kanban_record_title"><field name="code"/></strong>
								</div>
								<div t-if="record.to_renew.raw_value" class="badge badge-warning border-0 mt4">
									To Renew
								</div>
								<div class="text-muted o_kanban_record_subtitle mt8">
									<t t-if="record.recurring_total.raw_value">
										<field name="recurring_total" widget="monetary" options="{'currency_field': 'company_currency'}"/>
										<span t-if="record.partner_id.value">,</span>
									</t>
									<span t-if="record.partner_id.value"><t t-esc="record.partner_id.value"/></span>
								</div>
								<div t-if="record.rating_status.raw_value != 'no'" class="mt8 text-primary" title="Percentage of happy ratings over the past 30 days. Get rating details from the More menu." groups="project.group_project_rating">
                                    <b>
                                        <t t-if="record.rating_percentage_satisfaction.value == -1">
                                            <i class="fa fa-smile-o"/> No rating yet
                                        </t>
                                        <t t-if="record.rating_percentage_satisfaction.value != -1">
                                            <a name="action_view_all_rating" type="object" context="{'search_default_rating_last_30_days':1}">
                                                <i class="fa fa-smile-o" role="img" aria-label="Percentage of satisfaction" title="Percentage of satisfaction"/> <t t-esc="record.rating_percentage_satisfaction.value"/>%
                                            </a>
                                        </t>
                                    </b>
                                </div>
								<div class="o_kanban_record_bottom mt8">
									<div class="oe_kanban_bottom_left">
										<field name="activity_ids" widget="kanban_activity" />
										<b t-if="record.rating_ids.raw_value.length">
											<span style="font-weight:bold;"
												class="fa fa-fw mt4 fa-smile-o text-success"
												t-if="record.rating_last_value.value == 10"
												title="Latest Rating: Satisfied" role="img"
												aria-label="Happy face" />
											<span style="font-weight:bold;"
												class="fa fa-fw mt4 fa-meh-o text-warning"
												t-if="record.rating_last_value.value == 5"
												title="Latest Rating: Not Satisfied" role="img"
												aria-label="Neutral face" />
											<span style="font-weight:bold;"
												class="fa fa-fw mt4 fa-frown-o text-danger"
												t-if="record.rating_last_value.value == 1"
												title="Latest Rating: Higly Dissatisfied" role="img"
												aria-label="Sad face" />
										</b>
									</div>
									<div class="oe_kanban_bottom_right">
										<img
											t-att-src="kanban_image('res.users', 'image_128', record.user_id.raw_value)"
											t-att-title="record.user_id.value"
											t-att-alt="record.user_id.value" width="24" height="24"
											class="oe_kanban_avatar" />
									</div>
								</div>
							</div>
							<div class="oe_clear"></div>
						</div>
					</t>
				</templates>
			</kanban>
		</field>
	</record>

	<record id="sale_subscription_view_search" model="ir.ui.view">
		<field name="name">sale.subscription.search</field>
		<field name="model">sale.subscription</field>
		<field name="arch" type="xml">
			<search string="Subscriptions">
				<field name="name" string="Subscription" />
				<field name="date_end" />
				<field name="partner_id" operator="child_of" />
				<field name="user_id" />
				<field name="template_id" />
				<field name="code" />
				<filter name="ftr_my_subscriptions" string="My Subscriptions" domain="[('user_id','=',uid)]" />
				<filter string="My Favorites" name="ftr_my_favorites" domain="[('favorite_user_ids', 'in', uid)]"/>
				<filter string="Unassigned" name="contracts_not_assigned" domain="[('user_id', '=', False)]" />
				<separator />
				<filter name="open" string="Running" domain="[('in_progress','=',True)]" />
				<filter name="pending" string="To Renew" domain="[('to_renew','=',True)]" />
				<filter name="closed" string="Closed" domain="[('in_progress','=',False)]" />
				<separator />
				<filter string="Late Activities" name="activities_overdue"
					domain="[('activity_ids.date_deadline', '&lt;', context_today().strftime('%Y-%m-%d'))]" />
				<filter string="Today Activities" name="activities_today"
					domain="[('activity_ids.date_deadline', '=', context_today().strftime('%Y-%m-%d'))]" />
				<filter string="Future Activities" name="activities_upcoming_all"
					domain="[('activity_ids.date_deadline', '&gt;', context_today().strftime('%Y-%m-%d'))]" />
				<separator />
				<group expand="0" string="Group By">
					<filter string="Stage" name="stage" domain="[]" context="{'group_by':'stage_id'}" />
					<filter string="Salesperson" name="sales_person" domain="[]" context="{'group_by':'user_id'}" />
					<filter string="Sales Team" name="sales_team" domain="[]" context="{'group_by':'team_id'}" />
					<filter string="Customer" name="customer" domain="[]" context="{'group_by':'partner_id'}" />
					<filter string="Country" name="country" domain="[]" context="{'group_by': 'country_id'}" />
					<filter string="Industry" name="industry" domain="[]" context="{'group_by': 'industry_id'}" />
					<filter string="Template" name="template" domain="[]" context="{'group_by':'template_id'}" />
					<filter string="Start Date" name="start_month" domain="[]" context="{'group_by' : 'date_start'}" />
					<filter string="End Date" name="end_month" domain="[]" context="{'group_by' : 'date_end'}" />
				</group>
			</search>
		</field>
	</record>

	<record id="sale_subscription_action" model="ir.actions.act_window">
		<field name="name">Subscriptions</field>
		<field name="res_model">sale.subscription</field>
		<field name="view_mode">kanban,tree,form,pivot,graph,activity</field>
		<field name="context">{"search_default_ftr_my_subscriptions":1}</field>
		<field name="domain">[]</field>
		<field name="search_view_id" eval='False' />
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
				Define a new subscription
			</p>
		</field>
	</record>

	<record id="sale_subscription_view_graph" model="ir.ui.view">
		<field name="name">sale.subscription.graph</field>
		<field name="model">sale.subscription</field>
		<field name="arch" type="xml">
			<graph string="Subscriptions">
				<field name="partner_id" />
				<field name="recurring_total" type="measure" />
			</graph>
		</field>
	</record>

	<record id="sale_subscription_view_pivot" model="ir.ui.view">
		<field name="name">sale.subscription.pivot</field>
		<field name="model">sale.subscription</field>
		<field name="arch" type="xml">
			<pivot string="Subscriptions">
				<field name="partner_id" />
				<field name="recurring_total" type="measure" />
			</pivot>
		</field>
	</record>

	<record id="sale_subscription_action_filtered" model="ir.actions.act_window">
		<field name="name">Subscriptions</field>
		<field name="res_model">sale.subscription</field>
		<field name="view_mode">tree,form,kanban,pivot,graph,activity</field>
		<field name="context">{
			'search_default_template_id': [active_id],
			'default_template_id': active_id,
			}
		</field>
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
				Define a new subscription
			</p>
		</field>
	</record>

	<record id="sale_subscription_action_pending" model="ir.actions.act_window">
		<field name="name">Subscriptions to Renew</field>
		<field name="res_model">sale.subscription</field>
		<field name="view_mode">tree,form,pivot,graph,kanban,activity</field>
		<field name="context">{
			'search_default_user_id':uid,
			'search_default_pending':1,
			'search_default_renew':1
			}
		</field>
		<field name="domain">[]</field>
		<field name="search_view_id" eval='False' />
		<field name="help" type="html">
			<p class="o_view_nocontent_smiling_face">
				Define a new subscription
			</p>
		</field>
	</record>

	<menuitem id="menu_sale_subscription_action"
		parent="menu_sale_subscription"
		action="sale_subscription_action" sequence="10" />

	<menuitem id="menu_sale_subscription_pending"
		parent="menu_sale_subscription"
		action="sale_subscription_action_pending" sequence="20" />

	<menuitem id="menu_sale_subscription_product"
		parent="menu_sale_subscription"
		action="product_template_action_subscription" sequence="30" />

	<record id="res_config_settings_action" model="ir.actions.act_window">
        <field name="name">Settings</field>
        <field name="type">ir.actions.act_window</field>
        <field name="res_model">res.config.settings</field>
        <field name="view_mode">form</field>
        <field name="target">inline</field>
        <field name="context">{'module' : 'to_sale_subscription'}</field>
    </record>

    <menuitem id="res_config_settings_menu" name="Settings" parent="menu_sale_subscription_config"
        sequence="0" action="res_config_settings_action" groups="base.group_system"/>

</odoo>
